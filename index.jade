- var cmdir = 'node_modules/codemirror/'
head
  title Perfect CodeMirror
  meta(key="description" value="Styles I like to apply to my CodeMirror instances")
  meta(key="author" value="Cole Lawrence (ZombieHippie@github.com)")
  meta(key="repository" value="http://github.com/ZombieHippie/perfect-codemirror")
  link(href=cmdir + "lib/codemirror.css" rel="stylesheet")
  style.
    /* Styles that I like in ACE and Sublime */
    .CodeMirror {
      font-family: 'source-code-pro', 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
      font-size: 16px;
      line-height: 1.3em;
    }
    .CodeMirror:hover {
      cursor: text;
    }
    .CodeMirror .cm-matchhighlight:not(.CodeMirror-selectedtext) {
      outline: 1px solid #bbb;
    }
    .CodeMirror-selected {
      background-color: #ddd !important;
    }
    .CodeMirror-focused div.CodeMirror-cursor {
      /* Whatever your cursor color is: */
      border-right: 1px solid black;
    }
    .CodeMirror-focused div.CodeMirror-cursors.blinking {
      -webkit-animation: CodeMirror-cursors 1.06s infinite;
      animation: CodeMirror-cursors 1.06s infinite;
    }
    @-webkit-keyframes CodeMirror-cursors
    {
      from,to,85%,15%  {opacity: 1}
      65%, 35% {opacity: 0}
    }
    @keyframes CodeMirror-cursors
    {
      from,to,85%,15%  {opacity: 1}
      65%, 35% {opacity: 0}
    }
    .cm-tab {
      background-position: right;
      background-repeat: no-repeat;
    }
    .CodeMirror-selectedtext .cm-tab {
      background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyBpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBXaW5kb3dzIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjQ2NDNDRjgyNjI5RjExRTM5RDJDRTFCOTg3NTNDOUU3IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOjQ2NDNDRjgzNjI5RjExRTM5RDJDRTFCOTg3NTNDOUU3Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NDY0M0NGODA2MjlGMTFFMzlEMkNFMUI5ODc1M0M5RTciIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6NDY0M0NGODE2MjlGMTFFMzlEMkNFMUI5ODc1M0M5RTciLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz6N/xw1AAAAdUlEQVR42mL8//8/w1AGTAxDHIx6gE5AEIgvAbEblP9/qHngPRDXAvFOIPZElmAEZuLvZBjIiBwKFMrD2IT0gAAHmhlAHcBSaIhgv/8QUAalweJDxfGCQPwbiOuhfLgHGIdYPQBKQj/Q88BoMTrqAQoAQIABAFQ3O9aohzjOAAAAAElFTkSuQmCC");
    }
    .CodeMirror-gutters:hover {
      cursor: default;
    }
    .CodeMirror {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      height: 100% !important;
    }

body
  #editor
  footer
    script(src=cmdir + "lib/codemirror.js")
    script(src=cmdir + "mode/css/css.js")
    script(src=cmdir + "mode/javascript/javascript.js")
    script(src=cmdir + "mode/xml/xml.js")
    script(src=cmdir + "mode/htmlmixed/htmlmixed.js")
    script(src=cmdir + "addon/search/searchcursor.js")
    script(src=cmdir + "addon/search/match-highlighter.js")
    script(src=cmdir + "addon/edit/closebrackets.js")
    script(src=cmdir + "keymap/sublime.js")
    script(src=cmdir + "addon/selection/mark-selection.js")
    script(src="extras/spaces-or-tabs.js")
    script.
      var content = document.documentElement.innerHTML
      var editor = CodeMirror(document.getElementById('editor'), {
        mode:'htmlmixed',
        lineNumbers: true,
        indentWithTabs: false,
        highlightSelectionMatches: true,
        styleSelectedText: true,
        styleActiveLine: true,
        indentUnit: 2,
        autoCloseBrackets: true,
        cursorBlinkRate: 530, // Set to 0 so we can blink with css
        showCursorWhenSelecting: true,
        keyMap: 'sublime',
        indentWithTabs: false,
        smartIndent: false,
        autofocus: true,
        extraKeys: {
          "Tab": checkToUseSpacesInsteadofTabs
        }
      })
      editor.setValue(content)
  script.
    // This is a patch I've written over my codemirror install to enable fancy blinking

    // Cursor-blinking
    function restartBlink(cm) {
      if (!cm.state.focused) return;
      var display = cm.display;
      clearInterval(display.blinker);
      // My code ZombieHippie@github.com
      display.cursorDiv.className = display.cursorDiv.className.replace(" blinking","");
      display.blinker = setTimeout(function () {
        display.cursorDiv.className += " blinking";
      }, cm.options.cursorBlinkRate);
      // The following commented code is the original code
      /*
      var on = true;
      display.cursorDiv.style.visibility = "";
      if (cm.options.cursorBlinkRate > 0)
        display.blinker = setInterval(function() {
          display.cursorDiv.style.visibility = (on = !on) ? "" : "hidden";
        }, cm.options.cursorBlinkRate);
      else if (cm.options.cursorBlinkRate < 0)
        display.cursorDiv.style.visibility = "hidden";
      */
    }